# This file is a template, and might need editing before it works on your project.
image: golang:latest

before_script:
  - git config --global url."https://code.bcarlin.xyz".insteadOf "ssh://git@code.bcarlin.xyz:2222"
  - cd $CI_PROJECT_DIR
  - env
  - go get github.com/golangci/golangci-lint/cmd/golangci-lint
after_script:
  - ln -s $GOPATH .gocache

cache:
  key: go_dependencies_cache
  paths:
  - $CI_PROJECT_DIR/.gocache/


stages:
    - test
    - build

tests:
    stage: test
    script:
      - gofmt -d -e ./pkg/ ./cmd/
      - ./make.sh check
      - go test -coverpkg ./cmd/...,./pkg/... -coverprofile cover.out -v ./cmd/... ./pkg/...
      - go tool cover -func=cover.out

compile:
    stage: build
    script:
      - export CGO_ENABLED=0
      - go build -ldflags "-s -w" -o $CI_PROJECT_DIR/waarp-gatewayd ./cmd/waarp-gatewayd
    artifacts:
      paths:
        - waarp-gatewayd
